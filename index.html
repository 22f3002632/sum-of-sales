<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <title>Sales Summary</title>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="mb-4">Sales Summary</h1>

    <div class="card shadow-sm">
      <div class="card-body d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Total Sales</span>
        <span id="total-sales" class="fs-3">0</span>
      </div>
    </div>

    <div id="status" class="text-muted mt-3"></div>
  </div>

  <script>
    (function () {
      function updateTitleWhenSeedAvailable() {
        const qsSeed = new URLSearchParams(location.search).get("seed");
        const hasWindowSeed = typeof window !== "undefined" && ("seed" in window);
        const seedVal = hasWindowSeed ? window.seed : (qsSeed || "");
        document.title = `Sales Summary ${seedVal}`;

        if (!hasWindowSeed) {
          const interval = setInterval(() => {
            if ("seed" in window) {
              document.title = `Sales Summary ${window.seed}`;
              clearInterval(interval);
            }
          }, 50);
          setTimeout(() => clearInterval(interval), 5000);
        }
      }

      function splitCSVLine(line) {
        const out = [];
        let cur = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuotes && line[i + 1] === '"') {
              cur += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (ch === "," && !inQuotes) {
            out.push(cur);
            cur = "";
          } else {
            cur += ch;
          }
        }
        out.push(cur);
        return out;
      }

      function parseCSV(text) {
        const lines = text.split(/\r?\n/).filter((l) => l.trim().length > 0);
        if (lines.length === 0) return { headers: [], rows: [] };
        const headers = splitCSVLine(lines[0]).map((h) => h.trim().replace(/^"(.*)"$/, "$1"));
        const rows = lines.slice(1).map((line) => splitCSVLine(line));
        return { headers, rows };
      }

      function toNumber(val) {
        if (val == null) return 0;
        const s = String(val).trim();
        if (!s) return 0;
        const cleaned = s.replace(/[^0-9.+\-eE]/g, "");
        const num = parseFloat(cleaned);
        return isNaN(num) ? 0 : num;
        }

      async function loadAndSum() {
        const statusEl = document.getElementById("status");
        try {
          const res = await fetch("data.csv", { cache: "no-store" });
          if (!res.ok) throw new Error("Network error: " + res.status);
          const text = await res.text();
          const { headers, rows } = parseCSV(text);

          const salesIdx = headers.findIndex((h) => h.trim().toLowerCase() === "sales");
          if (salesIdx === -1) throw new Error('No "sales" column found');

          let total = 0;
          for (const row of rows) {
            total += toNumber(row[salesIdx]);
          }

          document.getElementById("total-sales").textContent = String(total);
          if (statusEl) statusEl.textContent = "Loaded " + rows.length + " records.";
        } catch (err) {
          console.error(err);
          document.getElementById("total-sales").textContent = "0";
          const statusEl = document.getElementById("status");
          if (statusEl) statusEl.textContent = "Failed to load data.csv";
        }
      }

      updateTitleWhenSeedAvailable();
      loadAndSum();
    })();
  </script>
</body>
</html>